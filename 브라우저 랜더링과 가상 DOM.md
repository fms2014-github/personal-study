# 브라우저 랜더링과 가상 DOM

# DOM이란?

Document Object Model의 약자로 문서 객체를 표현하는 HTML 태그를 표현하기 위한 인터페이스다. 각 태그들은 트리 형태로 관리되며 인터페이스로써 각 태그를 조작할 수 있는 API를 제공해준다. 그리고 브라우저는 DOM API를 자바스크립트로 제공되며 이를 사용해 DOM에 접근할 수 있다.

DOM은 문서 객체의 구조만 가지고 있다. 우리가 브라우저로 보는 각 요소의 디자인적 부분은 CSSOM이라고 하는 css 문서 객체 모델을 통해 DOM 트리 노드들을 표현할 스타일 속성들을 렌더 트리에서 렌더링을 수행하게 된다.

# 가상 DOM이란?

DOM의 수정이 이뤄졌을 때 브라우저 렌더링 과정이 비효율적으로 동작하는 부분을 해소하기위해 DOM을 추상화시킨 것이다. 추상화한 DOM 객체는 메모리에 저장되어 있기 때문에 다른 DOM만 사용하는 웹 프레임워크 보다 메모리 사용량이 많은 편이다.

# 렌더링 과정이 비효율적인 이유

브라우저 렌더링 과정은 다음과 같은 순서로 이루어진다

1. HTML 태그를 파싱하여 DOM 트리 생성
2. CSS를 파싱하여 CSSOM 트리 생성
3. CSSOM트리와 DOM 트리를 가지고 렌더 트리 생성
4. 렌더트리의 정보를 가지고 레이어를 만든다
5. 생성된 레이어를 바탕으로 요소를 그려 레스터화 시킨다.

이 과정 자체는 문제가 없다. 그러나 문제는 렌더링 이후 DOM이나 CSSOM의 변경이 발생했을 때 발생한다. DOM이나 CSSOM의 일부만 변경되어도 상위 렌더링 과정을 다시 처음부터 진행된다. 즉, DOM이나 CSSOM의 변경이 발생 할 때마다 렌더링 과정을 반복 진행하게 되며 이는 지나친 리소스 낭비로 이어진다. 심하면 메모리 초과로 브라우저의 작동이 중지되는 상황까지도 간다.

특히 4번과 5번 과정이 렌더링 중 가장 많은 리소스를 사용한다. 각각 Reflow, Repaint 과정이라고 하는데 렌더링 시간을 줄이기 위해서는 Reflow와 Repaint가 덜 발생하도록 해야하며 이를 해소하는 방법 중 하나로 가상DOM이라는게 탄생하게 된 것이다.

## Reflow/Repaint

어떤 트리거에 의해 DOM이나 CSSOM의 변경이 발생한다면 바뀐 부분만 따로 렌더링이되는게 아니라 DOM트리 생성부터 레스터화까지 처리 과정을 한 번더 겪게 된다. DOM이나 CSSOM의 변경으로 인해 재 렌더링이 되는 구간은 크게 두 가지로 나누는데 하나는 Reflow고 다른 하나는 Repaint다.

### Reflow

HTML의 요소가 추가/삭제가 되었거나 CSSOM에 의해 요소의 크기나 위치가 변경이 되면 그로 인해 영향을 받는 다른 부모/자식/형제 요소들도 레이아웃 업데이트가 필요할 것이다. 이를 처리하는 과정을 Reflow라고 한다.

Reflow는 페이지 최초 렌더링, Viewport 변화, 노드/요소의 위치 변경, 크기 변화 등과 같은 변화가 발생하면 Reflow가 진행된다.

### Repaint

Repaint는 요소를 레스터화 해서 실제 모니터에 요소를 보여주게 하는 과정이다. 레스터화가 안된 요소는 브라우저에선 보이지 않기 때문에 Reflow가 완료된 이후에는 항상 Repaint가 진행된다.

그러나 요소의 추가/삭제나 요소 크기의 변동이 없이 요소의 색상, 테두리, 그림자 등과 같은 레스터 요소들만 변경이 일어나면 Reflow없이 Repaint만 진행되는 경우가 있다.

# 가상DOM이 렌더링에 효율적인 이유

가상DOM은 렌더링 과정에서 비효율적인 부분을 해소하기 위해 제안된 방법 중 하나다. 특히 싱글 페이지 어플리케이션(SPA)형태의 웹 앱에서 더욱 도드라진다.

SPA의 경우 명칭에 걸맞게 하나의 HTML위에서 화면 및 UI가 대부분 자바스크립트를 이용한 DOM 조작으로 만들어지기 때문에 MPA 구조의 웹페이지보다 더 잦은 DOM업데이트가 발생하고 렌더링 시간은 점점 늘어나게 된다.

그래서 가상DOM을 도입하여 DOM 업데이트가 발생하는 부분을 전부 가상DOM에서 처리하도록 한다. 가상DOM은 브라우저가 가지고 있는 DOM과 별개의 영역이기 때문에 아무리 가상DOM을 업데이트 하더라도 실시간으로 렌더링 작업이 발생하지 않는다.

DOM의 변경사항을 가상DOM이 전부 수집을 하고 나면 가상DOM은 변경되기 전의 DOM 상태와 변경된 DOM 상태를 Diffing 알고리즘으로 찾아내고 변경된 부분만 모아서 실제 DOM에 반영한다.

이런 처리 과정 덕분에 실제 발생한 DOM업데이트보다 훨씬 적은 횟수로 DOM의 재 렌더링이 진행되어 가상DOM을 사용하면 SPA 구조의 잦은 DOM 업데이트로 발생하는 문제점을 해결할 수 있는 것이다.